<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Custodia Frontend</title>
</head>
<body>
  <h2>Custodia Escrow Interface</h2>

  <button onclick="connectWallet()">Connect Wallet</button>
  <p id="walletAddress"></p>

  <hr/>

  <h3>Create Escrow</h3>
  Seller: <input type="text" id="seller" placeholder="0x..."><br/>
  Arbiter: <input type="text" id="arbiter" placeholder="0x..."><br/>
  <button onclick="createEscrow()">Create</button><br/>
  <p id="escrowIdResult"></p>

  <hr/>

  <h3>Deposit to Escrow</h3>
  Escrow ID: <input type="number" id="depositId"><br/>
  Amount (ETH): <input type="number" id="depositAmount"><br/>
  <button onclick="deposit()">Deposit</button>

  <hr/>

  <h3>Mark Delivered</h3>
  Escrow ID: <input type="number" id="deliveredId"><br/>
  <button onclick="markDelivered()">Mark Delivered</button>

  <hr/>

  <h3>Confirm Delivery</h3>
  Escrow ID: <input type="number" id="confirmId"><br/>
  <button onclick="confirmDelivery()">Confirm</button>

  <hr/>

  <h3>Raise Dispute</h3>
  Escrow ID: <input type="number" id="disputeId"><br/>
  <button onclick="raiseDispute()">Raise Dispute</button>

  <hr/>

  <h3>Resolve Dispute</h3>
  Escrow ID: <input type="number" id="resolveId"><br/>
  Award to Seller? 
  <select id="toSeller">
    <option value="true">Yes</option>
    <option value="false">No</option>
  </select><br/>
  <button onclick="resolveDispute()">Resolve</button>

  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
  <script>
    let provider, signer, contract;
    const contractAddress = "0xcecb1DCfA527d07DFf4c93dD01224F1C504aDc22"; // Replace with deployed address
    const abi = [
      
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			}
		],
		"name": "DeliveryConfirmed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "seller",
				"type": "address"
			}
		],
		"name": "DeliveryMarked",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "party",
				"type": "address"
			}
		],
		"name": "DisputeRaised",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "seller",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "arbiter",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "EscrowCreated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "FundsDeposited",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "arbiter",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "sellerAwarded",
				"type": "bool"
			}
		],
		"name": "Resolved",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			}
		],
		"name": "confirmDelivery",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_seller",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "_arbiter",
				"type": "address"
			}
		],
		"name": "createEscrow",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			}
		],
		"name": "deposit",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "escrows",
		"outputs": [
			{
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "seller",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "arbiter",
				"type": "address"
			},
			{
				"internalType": "enum CustodiaFactory.State",
				"name": "state",
				"type": "uint8"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "getEscrowsByUser",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			}
		],
		"name": "markDelivered",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "nextEscrowId",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			}
		],
		"name": "raiseDispute",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "toSeller",
				"type": "bool"
			}
		],
		"name": "resolveDispute",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "userEscrows",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "userEscrowsView",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}

    ];

    async function connectWallet() {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      contract = new ethers.Contract(contractAddress, abi, signer);
      const address = await signer.getAddress();
      document.getElementById("walletAddress").innerText = "Connected: " + address;
    }

    async function createEscrow() {
      const seller = document.getElementById("seller").value;
      const arbiter = document.getElementById("arbiter").value;
      const tx = await contract.createEscrow(seller, arbiter);
      const receipt = await tx.wait();
      const event = receipt.events.find(e => e.event === "EscrowCreated");
      document.getElementById("escrowIdResult").innerText = "Escrow ID: " + event.args.escrowId;
    }

    async function deposit() {
      const id = document.getElementById("depositId").value;
      const amount = ethers.utils.parseEther(document.getElementById("depositAmount").value);
      const tx = await contract.deposit(id, { value: amount });
      await tx.wait();
      alert("Deposit successful");
    }

    async function markDelivered() {
      const id = document.getElementById("deliveredId").value;
      const tx = await contract.markDelivered(id);
      await tx.wait();
      alert("Marked as delivered");
    }

    async function confirmDelivery() {
      const id = document.getElementById("confirmId").value;
      const tx = await contract.confirmDelivery(id);
      await tx.wait();
      alert("Delivery confirmed and payment released");
    }

    async function raiseDispute() {
      const id = document.getElementById("disputeId").value;
      const tx = await contract.raiseDispute(id);
      await tx.wait();
      alert("Dispute raised");
    }

    async function resolveDispute() {
      const id = document.getElementById("resolveId").value;
      const toSeller = document.getElementById("toSeller").value === "true";
      const tx = await contract.resolveDispute(id, toSeller);
      await tx.wait();
      alert("Dispute resolved");
    }
  </script>
</body>
</html>
