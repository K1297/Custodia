<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Custodia Escrow</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    .wallet-info { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    .wallet-address { font-weight: bold; }
    .btn { padding: 8px 14px; cursor: pointer; background: #333; color: white; border: none; border-radius: 5px; }
    input, select { margin: 4px 0; padding: 6px; width: 300px; max-width: 100%; }
    h3 { margin-top: 30px; }
    hr { margin: 30px 0; }
  </style>
</head>
<body>

  <!-- Wallet Connect -->
  <div class="wallet-info">
    <div class="wallet-address" id="walletAddress">Not connected</div>
    <button class="btn" id="connectWalletBtn">
      <i class="fas fa-wallet"></i> Connect Wallet
    </button>
  </div>

  <h3>Create Escrow</h3>
  Seller: <input type="text" id="seller" placeholder="0x..."><br/>
  Arbiter: <input type="text" id="arbiter" placeholder="0x..."><br/>
  <button class="btn" onclick="createEscrow()">Create</button>
  <p id="escrowIdResult"></p>

  <h3>Deposit to Escrow</h3>
  Escrow ID: <input type="number" id="depositId"><br/>
  Amount (ETH): <input type="number" id="depositAmount"><br/>
  <button class="btn" onclick="deposit()">Deposit</button>

  <h3>Mark Delivered</h3>
  Escrow ID: <input type="number" id="deliveredId"><br/>
  <button class="btn" onclick="markDelivered()">Mark Delivered</button>

  <h3>Confirm Delivery</h3>
  Escrow ID: <input type="number" id="confirmId"><br/>
  <button class="btn" onclick="confirmDelivery()">Confirm</button>

  <h3>Raise Dispute</h3>
  Escrow ID: <input type="number" id="disputeId"><br/>
  <button class="btn" onclick="raiseDispute()">Raise Dispute</button>

  <h3>Resolve Dispute</h3>
  Escrow ID: <input type="number" id="resolveId"><br/>
  Award to Seller?
  <select id="toSeller">
    <option value="true">Yes</option>
    <option value="false">No</option>
  </select><br/>
  <button class="btn" onclick="resolveDispute()">Resolve</button>

  <script>
    let currentAccount = null;
    let provider, signer, contract;

    const contractAddress = "0xcecb1DCfA527d07DFf4c93dD01224F1C504aDc22"; // Your Sepolia contract

    const abi = [ // Minimal ABI for interaction
      
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			}
		],
		"name": "DeliveryConfirmed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "seller",
				"type": "address"
			}
		],
		"name": "DeliveryMarked",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "party",
				"type": "address"
			}
		],
		"name": "DisputeRaised",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "seller",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "arbiter",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "EscrowCreated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "FundsDeposited",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "arbiter",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "sellerAwarded",
				"type": "bool"
			}
		],
		"name": "Resolved",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			}
		],
		"name": "confirmDelivery",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_seller",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "_arbiter",
				"type": "address"
			}
		],
		"name": "createEscrow",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			}
		],
		"name": "deposit",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "escrows",
		"outputs": [
			{
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "seller",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "arbiter",
				"type": "address"
			},
			{
				"internalType": "enum CustodiaFactory.State",
				"name": "state",
				"type": "uint8"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "getEscrowsByUser",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			}
		],
		"name": "markDelivered",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "nextEscrowId",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			}
		],
		"name": "raiseDispute",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "escrowId",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "toSeller",
				"type": "bool"
			}
		],
		"name": "resolveDispute",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "userEscrows",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "userEscrowsView",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}

    ];

    async function connectWallet() {
      if (typeof window.ethereum === 'undefined') {
        alert('No Ethereum provider detected. Please install Brave Wallet or MetaMask.');
        return;
      }

      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        const network = await provider.getNetwork();

        if (network.chainId !== 11155111) {
          alert("Please switch to Sepolia Testnet in your wallet.");
          return;
        }

        currentAccount = await signer.getAddress();
        document.getElementById('walletAddress').textContent =
          `Connected: ${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`;

        document.getElementById('connectWalletBtn').innerHTML =
          '<i class="fas fa-check-circle"></i> Connected';
        document.getElementById('connectWalletBtn').disabled = true;

        contract = new ethers.Contract(contractAddress, abi, signer);
        console.log("Contract loaded:", contract);
      } catch (error) {
        console.error("Wallet connection error:", error);
        alert('Connection failed: ' + (error.message || error));
      }
    }

    async function createEscrow() {
      try {
        const seller = document.getElementById("seller").value;
        const arbiter = document.getElementById("arbiter").value;
        const tx = await contract.createEscrow(seller, arbiter);
        const receipt = await tx.wait();
        const event = receipt.events.find(e => e.event === "EscrowCreated");
        document.getElementById("escrowIdResult").innerText = "Escrow ID: " + event.args.escrowId;
      } catch (err) {
        alert("Error creating escrow: " + err.message);
        console.error(err);
      }
    }

    async function deposit() {
      try {
        const id = document.getElementById("depositId").value;
        const amount = ethers.utils.parseEther(document.getElementById("depositAmount").value);
        const tx = await contract.deposit(id, { value: amount });
        await tx.wait();
        alert("Deposit successful.");
      } catch (err) {
        alert("Deposit failed: " + err.message);
        console.error(err);
      }
    }

    async function markDelivered() {
      try {
        const id = document.getElementById("deliveredId").value;
        const tx = await contract.markDelivered(id);
        await tx.wait();
        alert("Marked as delivered.");
      } catch (err) {
        alert("Failed to mark delivered: " + err.message);
        console.error(err);
      }
    }

    async function confirmDelivery() {
      try {
        const id = document.getElementById("confirmId").value;
        const tx = await contract.confirmDelivery(id);
        await tx.wait();
        alert("Delivery confirmed and funds released.");
      } catch (err) {
        alert("Confirmation failed: " + err.message);
        console.error(err);
      }
    }

    async function raiseDispute() {
      try {
        const id = document.getElementById("disputeId").value;
        const tx = await contract.raiseDispute(id);
        await tx.wait();
        alert("Dispute raised.");
      } catch (err) {
        alert("Failed to raise dispute: " + err.message);
        console.error(err);
      }
    }

    async function resolveDispute() {
      try {
        const id = document.getElementById("resolveId").value;
        const toSeller = document.getElementById("toSeller").value === "true";
        const tx = await contract.resolveDispute(id, toSeller);
        await tx.wait();
        alert("Dispute resolved.");
      } catch (err) {
        alert("Resolution failed: " + err.message);
        console.error(err);
      }
    }

    document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
  </script>
</body>
</html>
