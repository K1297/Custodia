<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custodia Escrow Service</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
    <style>
        :root {
            --primary: #6a11cb;
            --secondary: #2575fc;
            --success: #00b09b;
            --warning: #ffa502;
            --danger: #ff4757;
            --dark: #1a1c28;
            --light: #f5f6fa;
            --card-bg: rgba(255, 255, 255, 0.08);
            --card-border: rgba(255, 255, 255, 0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.85;
            max-width: 600px;
            margin: 0 auto 25px;
            color: #d0d0ff;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .card-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .wallet-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .wallet-address {
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            border: 1px solid rgba(106, 17, 203, 0.5);
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.05rem;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(106, 17, 203, 0.6);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #00c9a7);
            box-shadow: 0 5px 15px rgba(0, 180, 155, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ffb142);
            box-shadow: 0 5px 15px rgba(255, 165, 2, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #ff6b81);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
        }
        
        .state-machine {
            display: flex;
            justify-content: space-between;
            margin: 40px 0;
            position: relative;
        }
        
        .state-machine::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255,255,255,0.1);
            transform: translateY(-50%);
            z-index: 1;
        }
        
        .state-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
            position: relative;
            flex: 1;
        }
        
        .state-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            background: var(--dark);
            border: 3px solid rgba(255,255,255,0.2);
            transition: all 0.4s ease;
            font-size: 1.5rem;
        }
        
        .state-item.active .state-icon {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transform: scale(1.15);
            box-shadow: 0 0 25px rgba(106, 17, 203, 0.6);
            border-color: rgba(255,255,255,0.5);
        }
        
        .state-item.completed .state-icon {
            background: var(--success);
        }
        
        .state-label {
            text-align: center;
            font-size: 1rem;
            font-weight: 500;
            color: #d0d0ff;
        }
        
        .contract-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .detail-card {
            background: rgba(0,0,0,0.25);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(106, 17, 203, 0.2);
        }
        
        .detail-title {
            font-size: 1rem;
            opacity: 0.7;
            margin-bottom: 10px;
            color: #a0a0e0;
        }
        
        .detail-value {
            font-size: 1.3rem;
            font-weight: 600;
            word-break: break-all;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .role-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
            background: rgba(255,255,255,0.1);
            margin-left: 10px;
        }
        
        .badge-buyer {
            background: linear-gradient(135deg, var(--primary), #8a2be2);
        }
        
        .badge-seller {
            background: linear-gradient(135deg, #00b09b, #00c9a7);
        }
        
        .badge-arbiter {
            background: linear-gradient(135deg, #ffa502, #ffb142);
        }
        
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .action-card {
            display: flex;
            flex-direction: column;
            padding: 25px;
            border-radius: 15px;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(106, 17, 203, 0.2);
        }
        
        .action-icon {
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .action-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .action-desc {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 25px;
            flex-grow: 1;
            color: #c0c0ff;
        }
        
        .events-log {
            max-height: 350px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .event-item {
            padding: 20px;
            margin-bottom: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            border-left: 4px solid var(--primary);
        }
        
        .event-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: rgba(106, 17, 203, 0.2);
            font-size: 1.5rem;
        }
        
        .event-content {
            flex-grow: 1;
        }
        
        .event-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.2rem;
        }
        
        .event-details {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        .event-time {
            font-size: 0.9rem;
            opacity: 0.6;
            text-align: right;
            min-width: 80px;
        }
        
        .status-message {
            padding: 18px;
            border-radius: 12px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1rem;
        }
        
        .status-success {
            background: rgba(0, 180, 155, 0.15);
            border-left: 4px solid var(--success);
        }
        
        .status-error {
            background: rgba(255, 71, 87, 0.15);
            border-left: 4px solid var(--danger);
        }
        
        .status-info {
            background: rgba(37, 117, 252, 0.15);
            border-left: 4px solid var(--secondary);
        }
        
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 12px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #2c3e50, #1a2a6c);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        
        .close-modal:hover {
            opacity: 1;
        }
        
        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.2);
            color: white;
            font-size: 1rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .state-machine {
                flex-wrap: wrap;
            }
            
            .state-item {
                width: 50%;
                margin-bottom: 30px;
            }
            
            .state-machine::before {
                display: none;
            }
            
            .contract-details {
                grid-template-columns: 1fr;
            }
            
            .card-header {
                flex-direction: column;
                gap: 20px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 0.95rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-lock logo-icon"></i>
            </div>
            <h1>Custodia Escrow Service</h1>
            <p class="subtitle">Secure blockchain escrow platform for trusted transactions between buyers and sellers</p>
        </header>
        
        <div class="card">
            <div class="card-header">
                <div class="card-title">Escrow Dashboard</div>
                <div class="wallet-info">
                    <div class="wallet-address" id="walletAddress">Not connected</div>
                    <button class="btn" id="connectWalletBtn">
                        <i class="fas fa-wallet"></i> Connect Wallet
                    </button>
                </div>
            </div>
            
            <div id="statusMessage"></div>
            
            <div class="state-machine">
                <div class="state-item active" data-state="0">
                    <div class="state-icon">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <div class="state-label">Created</div>
                </div>
                <div class="state-item" data-state="1">
                    <div class="state-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="state-label">Funded</div>
                </div>
                <div class="state-item" data-state="2">
                    <div class="state-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="state-label">Delivered</div>
                </div>
                <div class="state-item" data-state="3">
                    <div class="state-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="state-label">Confirmed</div>
                </div>
                <div class="state-item" data-state="4">
                    <div class="state-icon">
                        <i class="fas fa-gavel"></i>
                    </div>
                    <div class="state-label">Disputed</div>
                </div>
                <div class="state-item" data-state="5">
                    <div class="state-icon">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="state-label">Resolved</div>
                </div>
            </div>
            
            <div class="contract-details">
                <div class="detail-card">
                    <div class="detail-title">Buyer</div>
                    <div class="detail-value" id="buyerAddress">
                        0x0000...0000
                    </div>
                </div>
                <div class="detail-card">
                    <div class="detail-title">Seller</div>
                    <div class="detail-value" id="sellerAddress">
                        0x0000...0000
                    </div>
                </div>
                <div class="detail-card">
                    <div class="detail-title">Arbiter</div>
                    <div class="detail-value" id="arbiterAddress">
                        0x0000...0000
                    </div>
                </div>
                <div class="detail-card">
                    <div class="detail-title">Escrow Amount</div>
                    <div class="detail-value" id="escrowAmount">0 ETH</div>
                </div>
            </div>
            
            <h3 style="margin-bottom: 25px; font-size: 1.5rem; color: #d0d0ff;">Available Actions</h3>
            <div class="actions-grid" id="actionsGrid">
                <!-- Actions will be populated dynamically -->
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <div class="card-title">Transaction Events</div>
            </div>
            <div class="events-log" id="eventsLog">
                <div class="event-item">
                    <div class="event-icon">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <div class="event-content">
                        <div class="event-title">Contract Created</div>
                        <div class="event-details">Escrow contract initialized by buyer</div>
                    </div>
                    <div class="event-time">Just now</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Deposit Modal -->
    <div class="modal" id="depositModal">
        <div class="modal-content">
            <span class="close-modal" id="closeDepositModal">&times;</span>
            <h3 class="modal-title">Deposit Funds</h3>
            <div class="form-group">
                <label for="depositAmount">Amount (ETH)</label>
                <input type="number" id="depositAmount" min="0.001" step="0.001" placeholder="Enter ETH amount" value="1.5">
            </div>
            <div class="modal-actions">
                <button class="btn" id="confirmDepositBtn">Deposit</button>
                <button class="btn btn-danger" id="cancelDepositBtn">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Resolve Dispute Modal -->
    <div class="modal" id="resolveModal">
        <div class="modal-content">
            <span class="close-modal" id="closeResolveModal">&times;</span>
            <h3 class="modal-title">Resolve Dispute</h3>
            <p style="margin-bottom: 20px;">Who should receive the escrowed funds?</p>
            <div class="modal-actions">
                <button class="btn btn-success" id="awardSellerBtn">Award to Seller</button>
                <button class="btn btn-danger" id="awardBuyerBtn">Award to Buyer</button>
            </div>
        </div>
    </div>
    
    <script>
        // Contract ABI - Based on your smart contract
        const contractABI = [
            {
                "inputs": [
                    {"internalType": "address","name": "_seller","type": "address"},
                    {"internalType": "address","name": "_arbiter","type": "address"}
                ],
                "stateMutability": "payable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true,"internalType": "address","name": "buyer","type": "address"},
                    {"indexed": false,"internalType": "uint256","name": "amount","type": "uint256"}
                ],
                "name": "FundsDeposited",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true,"internalType": "address","name": "seller","type": "address"}
                ],
                "name": "DeliveryMarked",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true,"internalType": "address","name": "buyer","type": "address"}
                ],
                "name": "DeliveryConfirmed",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true,"internalType": "address","name": "party","type": "address"}
                ],
                "name": "DisputeRaised",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true,"internalType": "address","name": "arbiter","type": "address"},
                    {"indexed": false,"internalType": "bool","name": "sellerAwarded","type": "bool"}
                ],
                "name": "Resolved",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "deposit",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "markDelivered",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "confirmDelivery",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "raiseDispute",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "bool","name": "toSeller","type": "bool"}
                ],
                "name": "resolveDispute",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "amount",
                "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "arbiter",
                "outputs": [{"internalType": "address","name": "","type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "buyer",
                "outputs": [{"internalType": "address","name": "","type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "seller",
                "outputs": [{"internalType": "address","name": "","type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "state",
                "outputs": [{"internalType": "enum Custodia.State","name": "","type": "uint8"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];
        
        // Contract address - Replace with your deployed contract address
        const contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        
        // DOM Elements
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletAddressEl = document.getElementById('walletAddress');
        const buyerAddressEl = document.getElementById('buyerAddress');
        const sellerAddressEl = document.getElementById('sellerAddress');
        const arbiterAddressEl = document.getElementById('arbiterAddress');
        const escrowAmountEl = document.getElementById('escrowAmount');
        const actionsGrid = document.getElementById('actionsGrid');
        const eventsLog = document.getElementById('eventsLog');
        const statusMessage = document.getElementById('statusMessage');
        const stateItems = document.querySelectorAll('.state-item');
        
        // Modal elements
        const depositModal = document.getElementById('depositModal');
        const resolveModal = document.getElementById('resolveModal');
        const depositAmountInput = document.getElementById('depositAmount');
        const confirmDepositBtn = document.getElementById('confirmDepositBtn');
        const cancelDepositBtn = document.getElementById('cancelDepositBtn');
        const awardSellerBtn = document.getElementById('awardSellerBtn');
        const awardBuyerBtn = document.getElementById('awardBuyerBtn');
        
        // Global variables
        let provider;
        let signer;
        let contract;
        let userAddress;
        let contractState = 0; // Created
        let contractAmount = 0;
        
        // Initialize
        window.addEventListener('load', async () => {
            // Check if MetaMask is installed
            if (typeof window.ethereum !== 'undefined') {
                await initApp();
            } else {
                showStatus('Please install MetaMask to use this dApp!', 'error');
                connectWalletBtn.disabled = true;
            }
        });
        
        // Connect Wallet
        connectWalletBtn.addEventListener('click', async () => {
            try {
                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                await initApp();
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showStatus('Error connecting wallet: ' + error.message, 'error');
            }
        });
        
        // Initialize application
        async function initApp() {
            try {
                // Create ethers provider and signer
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Update wallet UI
                walletAddressEl.textContent = shortenAddress(userAddress);
                connectWalletBtn.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                
                // Create contract instance
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                
                // Load contract data
                await loadContractData();
                
                // Set up event listeners
                setupEventListeners();
            } catch (error) {
                console.error('Initialization error:', error);
                showStatus('Initialization error: ' + error.message, 'error');
            }
        }
        
        // Load contract data
        async function loadContractData() {
            try {
                // Get contract details
                const buyer = await contract.buyer();
                const seller = await contract.seller();
                const arbiter = await contract.arbiter();
                contractAmount = await contract.amount();
                contractState = await contract.state();
                
                // Update UI
                buyerAddressEl.innerHTML = `${shortenAddress(buyer)} ${buyer === userAddress ? '<span class="role-badge badge-buyer">You</span>' : ''}`;
                sellerAddressEl.innerHTML = `${shortenAddress(seller)} ${seller === userAddress ? '<span class="role-badge badge-seller">You</span>' : ''}`;
                arbiterAddressEl.innerHTML = `${shortenAddress(arbiter)} ${arbiter === userAddress ? '<span class="role-badge badge-arbiter">You</span>' : ''}`;
                escrowAmountEl.textContent = `${ethers.utils.formatEther(contractAmount)} ETH`;
                
                // Update state visualization
                updateStateVisualization();
                
                // Update available actions
                updateAvailableActions();
            } catch (error) {
                console.error('Error loading contract data:', error);
                showStatus('Error loading contract data: ' + error.message, 'error');
            }
        }
        
        // Update state visualization
        function updateStateVisualization() {
            // Reset all states
            stateItems.forEach(item => {
                item.classList.remove('active', 'completed');
            });
            
            // Mark completed states
            for (let i = 0; i < contractState; i++) {
                const stateItem = document.querySelector(`.state-item[data-state="${i}"]`);
                if (stateItem) stateItem.classList.add('completed');
            }
            
            // Mark active state
            const activeStateItem = document.querySelector(`.state-item[data-state="${contractState}"]`);
            if (activeStateItem) activeStateItem.classList.add('active');
        }
        
        // Update available actions based on state and user role
        async function updateAvailableActions() {
            // Clear previous actions
            actionsGrid.innerHTML = '';
            
            // Get user role
            const isBuyer = userAddress === await contract.buyer();
            const isSeller = userAddress === await contract.seller();
            const isArbiter = userAddress === await contract.arbiter();
            
            // Add actions based on current state
            switch(contractState) {
                case 0: // Created
                    if (isBuyer) {
                        addAction(
                            'Deposit Funds', 
                            'fas fa-money-bill-wave', 
                            'Fund the escrow to start the transaction', 
                            () => showModal(depositModal)
                        );
                    }
                    break;
                    
                case 1: // Funded
                    if (isSeller) {
                        addAction(
                            'Mark as Delivered', 
                            'fas fa-truck', 
                            'Confirm that the item/service has been delivered', 
                            markDelivered
                        );
                    }
                    
                    if (isBuyer || isSeller) {
                        addAction(
                            'Raise Dispute', 
                            'fas fa-gavel', 
                            'Initiate a dispute for the arbiter to resolve', 
                            raiseDispute
                        );
                    }
                    break;
                    
                case 2: // Delivered
                    if (isBuyer) {
                        addAction(
                            'Confirm Delivery', 
                            'fas fa-check-circle', 
                            'Release funds to the seller', 
                            confirmDelivery
                        );
                    }
                    break;
                    
                case 4: // Disputed
                    if (isArbiter) {
                        addAction(
                            'Resolve Dispute', 
                            'fas fa-balance-scale', 
                            'Decide the outcome of the dispute', 
                            () => showModal(resolveModal)
                        );
                    }
                    break;
                    
                default:
                    addAction(
                        'Transaction Complete', 
                        'fas fa-check', 
                        'This escrow transaction has been completed', 
                        null,
                        true
                    );
            }
        }
        
        // Add an action card to the UI
        function addAction(title, icon, description, handler, disabled = false) {
            const actionCard = document.createElement('div');
            actionCard.className = 'action-card';
            actionCard.innerHTML = `
                <div class="action-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="action-title">${title}</div>
                <div class="action-desc">${description}</div>
                <button class="btn ${disabled ? 'btn-disabled' : ''}" ${disabled ? 'disabled' : ''}>
                    ${title}
                </button>
            `;
            
            if (!disabled && handler) {
                const actionBtn = actionCard.querySelector('button');
                actionBtn.addEventListener('click', handler);
            }
            
            actionsGrid.appendChild(actionCard);
        }
        
        // Contract interaction functions
        async function depositFunds() {
            try {
                const amount = depositAmountInput.value;
                if (!amount || parseFloat(amount) <= 0) {
                    showStatus('Please enter a valid amount', 'error');
                    return;
                }
                
                const amountWei = ethers.utils.parseEther(amount);
                showStatus('Processing deposit transaction...');
                
                const tx = await contract.deposit({ value: amountWei });
                await tx.wait();
                
                showStatus('Deposit successful! Funds added to escrow.', 'success');
                await loadContractData();
                closeModal(depositModal);
            } catch (error) {
                console.error('Deposit error:', error);
                showStatus('Deposit failed: ' + error.message, 'error');
            }
        }
        
        async function markDelivered() {
            try {
                showStatus('Marking as delivered...');
                const tx = await contract.markDelivered();
                await tx.wait();
                
                showStatus('Item/service marked as delivered!', 'success');
                await loadContractData();
            } catch (error) {
                console.error('Mark delivered error:', error);
                showStatus('Error marking delivered: ' + error.message, 'error');
            }
        }
        
        async function confirmDelivery() {
            try {
                showStatus('Confirming delivery...');
                const tx = await contract.confirmDelivery();
                await tx.wait();
                
                showStatus('Delivery confirmed! Funds released to seller.', 'success');
                await loadContractData();
            } catch (error) {
                console.error('Confirm delivery error:', error);
                showStatus('Error confirming delivery: ' + error.message, 'error');
            }
        }
        
        async function raiseDispute() {
            try {
                showStatus('Raising dispute...');
                const tx = await contract.raiseDispute();
                await tx.wait();
                
                showStatus('Dispute raised! Waiting for arbiter resolution.', 'success');
                await loadContractData();
            } catch (error) {
                console.error('Raise dispute error:', error);
                showStatus('Error raising dispute: ' + error.message, 'error');
            }
        }
        
        async function resolveDispute(awardToSeller) {
            try {
                showStatus('Resolving dispute...');
                const tx = await contract.resolveDispute(awardToSeller);
                await tx.wait();
                
                const recipient = awardToSeller ? 'seller' : 'buyer';
                showStatus(`Dispute resolved! Funds awarded to ${recipient}.`, 'success');
                await loadContractData();
                closeModal(resolveModal);
            } catch (error) {
                console.error('Resolve dispute error:', error);
                showStatus('Error resolving dispute: ' + error.message, 'error');
            }
        }
        
        // Event listeners setup
        function setupEventListeners() {
            // Modal controls
            document.getElementById('closeDepositModal').addEventListener('click', () => closeModal(depositModal));
            document.getElementById('closeResolveModal').addEventListener('click', () => closeModal(resolveModal));
            cancelDepositBtn.addEventListener('click', () => closeModal(depositModal));
            
            // Deposit button
            confirmDepositBtn.addEventListener('click', depositFunds);
            
            // Resolve dispute buttons
            awardSellerBtn.addEventListener('click', () => resolveDispute(true));
            awardBuyerBtn.addEventListener('click', () => resolveDispute(false));
            
            // Contract events
            contract.on('FundsDeposited', (buyer, amount) => {
                addEvent(
                    'Funds Deposited',
                    'fas fa-money-bill-wave',
                    `${shortenAddress(buyer)} deposited ${ethers.utils.formatEther(amount)} ETH`,
                    new Date()
                );
            });
            
            contract.on('DeliveryMarked', (seller) => {
                addEvent(
                    'Item Delivered',
                    'fas fa-truck',
                    `${shortenAddress(seller)} marked the item as delivered`,
                    new Date()
                );
            });
            
            contract.on('DeliveryConfirmed', (buyer) => {
                addEvent(
                    'Delivery Confirmed',
                    'fas fa-check-circle',
                    `${shortenAddress(buyer)} confirmed delivery and released funds`,
                    new Date()
                );
            });
            
            contract.on('DisputeRaised', (party) => {
                addEvent(
                    'Dispute Raised',
                    'fas fa-gavel',
                    `${shortenAddress(party)} raised a dispute`,
                    new Date()
                );
            });
            
            contract.on('Resolved', (arbiter, sellerAwarded) => {
                const recipient = sellerAwarded ? 'Seller' : 'Buyer';
                addEvent(
                    'Dispute Resolved',
                    'fas fa-balance-scale',
                    `${shortenAddress(arbiter)} resolved the dispute in favor of ${recipient}`,
                    new Date()
                );
            });
        }
        
        // Add event to log
        function addEvent(title, icon, details, timestamp) {
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.innerHTML = `
                <div class="event-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="event-content">
                    <div class="event-title">${title}</div>
                    <div class="event-details">${details}</div>
                </div>
                <div class="event-time">${formatTime(timestamp)}</div>
            `;
            
            eventsLog.prepend(eventItem);
            
            // Auto-scroll to top
            eventsLog.scrollTop = 0;
        }
        
        // Show status message
        function showStatus(message, type = 'info') {
            statusMessage.innerHTML = '';
            
            if (!message) return;
            
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            statusMessage.appendChild(statusDiv);
            
            // Clear message after 5 seconds
            if (type !== 'info') {
                setTimeout(() => {
                    statusDiv.remove();
                }, 5000);
            }
        }
        
        // Modal functions
        function showModal(modal) {
            modal.style.display = 'flex';
        }
        
        function closeModal(modal) {
            modal.style.display = 'none';
        }
        
        // Helper functions
        function shortenAddress(address) {
            return address ? `${address.substring(0, 6)}...${address.substring(address.length - 4)}` : '';
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>
